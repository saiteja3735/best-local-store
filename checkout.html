<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BestStore | Checkout</title>

<script type="module">
import { db } from './firebaseConfig3735.js';
import { collection, getDocs, query, where, doc, getDoc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js';

const checkoutData = JSON.parse(localStorage.getItem('checkoutData'));
if (!checkoutData || !checkoutData.cart || checkoutData.cart.length === 0) {
    alert("Your cart is empty or session expired.");
    window.location.href = "cart.html";
}
const currentUser = checkoutData.user;
let userDetails = {};
let totalAmount = 0;

// Load user details
async function loadUserDetails() {
    try {
        let q;
        if (currentUser.identifierUsed.includes("@")) {
            q = query(collection(db, "users"), where("email", "==", currentUser.identifierUsed));
        } else {
            q = query(collection(db, "users"), where("mobile", "==", currentUser.identifierUsed));
        }

        const snap = await getDocs(q);
        if (!snap.empty) {
            userDetails = snap.docs[0].data();
        } else {
            userDetails = { name: "", email: "", mobile: "", address: "", city: "", pincode: "" };
        }

        document.getElementById("name").value = userDetails.name || "";
        document.getElementById("email").value = userDetails.email || "";
        document.getElementById("mobile").value = userDetails.mobile || "";
        document.getElementById("address").value = userDetails.address || "";
        document.getElementById("city").value = userDetails.city || "";
        document.getElementById("pincode").value = userDetails.pincode || "";

        if (userDetails.pincode) await fetchCityFromPincode(userDetails.pincode);

    } catch (err) {
        console.error("Error loading user details:", err);
    }
}

// Load order summary
async function loadOrderSummary() {
    const summaryContainer = document.getElementById("order-summary");
    summaryContainer.innerHTML = "";
    totalAmount = 0;

    for (const item of checkoutData.cart) {
        const productRef = doc(db, "products", item.product_id);
        const productSnap = await getDoc(productRef);
        if (!productSnap.exists()) continue;

        const product = productSnap.data();
        const quantity = item.quantity;
        const subtotal = product.price * quantity;
        totalAmount += subtotal;

        const div = document.createElement("div");
        div.classList.add("summary-item");
        div.innerHTML = `<div><strong>${product.product_name}</strong> (x${quantity})</div><div>₹${subtotal.toFixed(2)}</div>`;
        summaryContainer.appendChild(div);

        // Update item with product name
        item.product_name = product.product_name;
        item.price = product.price;
        item.subtotal = subtotal;
    }

    document.getElementById("total-price").textContent = `₹${totalAmount.toFixed(2)}`;
}

// City autofill
async function fetchCityFromPincode(pincode) {
    const cityInput = document.getElementById("city");
    if (pincode.length !== 6) return;

    try {
        const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
        const data = await response.json();
        if (data[0].Status === "Success" && data[0].PostOffice.length > 0) {
            const postOffices = data[0].PostOffice;
            let exactLocation = postOffices.find(po => po.DeliveryStatus === "Delivery")?.Name || postOffices[0].Name;
            cityInput.value = exactLocation;
        } else {
            cityInput.value = "";
        }
    } catch (err) {
        console.error("Error fetching city:", err);
        cityInput.value = "";
    }
}

// Pincode blur
document.getElementById("pincode").addEventListener("blur", async () => {
    const pincode = document.getElementById("pincode").value.trim();
    await fetchCityFromPincode(pincode);
});

// WhatsApp Payment Button
document.getElementById("whatsapp-payment").addEventListener("click", async () => {
    const deliveryInfo = {
        name: document.getElementById("name").value.trim(),
        email: document.getElementById("email").value.trim(),
        mobile: document.getElementById("mobile").value.trim(),
        address: document.getElementById("address").value.trim(),
        city: document.getElementById("city").value.trim(),
        pincode: document.getElementById("pincode").value.trim()
    };

    if (!deliveryInfo.name || !deliveryInfo.email || !deliveryInfo.mobile || !deliveryInfo.address || !deliveryInfo.city || !deliveryInfo.pincode) {
        alert("Please fill all delivery details before proceeding.");
        return;
    }

    // Prepare WhatsApp message
    let message = `*BestStore Order*\n\nCustomer: ${deliveryInfo.name}\nMobile: ${deliveryInfo.mobile}\nEmail: ${deliveryInfo.email}\nAddress: ${deliveryInfo.address}, ${deliveryInfo.city} - ${deliveryInfo.pincode}\n\nOrder Details:\n`;
    checkoutData.cart.forEach(item => {
        message += `• ${item.product_name} x${item.quantity} = ₹${item.subtotal.toFixed(2)}\n`;
    });
    message += `\nTotal Amount: ₹${totalAmount.toFixed(2)}\n\nPayment instructions will be sent via WhatsApp. We will contact you shortly.`;

    const whatsappNumber = "9703263623";
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

    // Save complete order to Firestore
    try {
        await addDoc(collection(db, "orders"), {
            user: currentUser.identifierUsed,
            deliveryInfo,
            cart: checkoutData.cart,
            totalAmount,
            status: "Order Placed",
            createdAt: serverTimestamp()
        });

        // Clear cart and checkout data
        localStorage.removeItem('checkoutData');
        localStorage.removeItem('cart');

        alert("Order placed! Redirecting to WhatsApp for payment.");
        window.open(whatsappUrl, "_blank");
        window.location.href = "cart.html";
    } catch (err) {
        console.error("Error saving order:", err);
        alert("Failed to place order. Try again.");
    }
});

document.addEventListener("DOMContentLoaded", async () => {
    await loadUserDetails();
    await loadOrderSummary();
});
</script>

<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; }
header { background: #e65100; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
header a { color: white; text-decoration: none; margin: 0 10px; }
.container { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; }
h2 { border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 15px; }
form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
form input, form textarea { padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 5px; }
form textarea { grid-column: span 2; resize: vertical; height: 60px; }
.order-summary { margin-top: 20px; }
.summary-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; }
.total { font-weight: bold; font-size: 1.2em; margin-top: 10px; text-align: right; }
button { background: green; color: white; padding: 10px; border: none; font-size: 16px; cursor: pointer; margin-top: 15px; border-radius: 5px; }
#whatsapp-note { color: #e65100; font-weight: bold; margin-bottom: 10px; }
</style>
</head>
<body>

<header>
    <a href="cart.html">← Back to Cart</a>
    <a href="dashboard.html">Home</a>
</header>

<div class="container">
    <h2>Delivery Details</h2>
    <form id="delivery-form">
        <input type="text" id="name" placeholder="Full Name" required />
        <input type="email" id="email" placeholder="Email" required />
        <input type="text" id="mobile" placeholder="Mobile" required />
        <textarea id="address" placeholder="Full Address" required></textarea>
        <input type="text" id="city" placeholder="City" required />
        <input type="text" id="pincode" placeholder="Pincode" required />
    </form>

    <h2>Order Summary</h2>
    <div class="order-summary" id="order-summary"></div>
    <div class="total">Total: <span id="total-price">₹0</span></div>

    <div id="whatsapp-note">Click below to pay via WhatsApp for faster order processing.</div>
    <button id="whatsapp-payment">Pay via WhatsApp</button>
</div>

</body>
</html>
